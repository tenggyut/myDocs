##Simple CI Environment Setup Guide

####Software And Environment

- OS: Centos 6.3
- Java: 1.7.0_79
- Maven: 3.3.9
- Gradle: 2.9
- Mysql: mysql community 5.7.9-1
- Jenkins: 1.638
- Sonar: 5.2.0

####Setup

#####1. Java

execute the following command in your termial

```
shell> cd /opt
shell> wget http://download.oracle.com/otn-pub/java/jdk/7u79-b15/jdk-7u79-linux-x64.tar.gz
shell> tar axf jdk-7u79-linux-x64.tar.gz
shell> echo "export JAVA_HOME=/opt/jdk1.7.0_79" >> /etc/profile.d/java.sh
shell> echo "export PATH=$PATH:$JAVA_HOME/bin" >> /etc/profile.d/java.sh
shell> source /etc/profile
```
at this point, your Java Environment should be OK. issue this command to check:

```
shell> java -version
```

#####2. Maven

```
shell> cd /opt
shell> wget http://mirrors.cnnic.cn/apache/maven/maven-3/3.3.9/binaries/apache-maven-3.3.9-bin.tar.gz
shell> tar axf apache-maven-3.3.9-bin.tar.gz
shell> echo "export MAVEN_HOME=/opt/apache-maven-3.3.9" >> /etc/profile.d/maven.sh
shell> echo "export PATH=$PATH:$MAVEN_HOME/bin" >> /etc/profile.d/maven.sh
shell> source /etc/profile
```

that's it, you should be set for maven right now. But there are still some tweaks in *${MAVEN_HOME}/conf/settings.xml* you might want to customize:

 - change default local repo path. uncomment the localRepository markup and replace the default value with whatever you perfer.
 - if you have a private maven repository, add a mirror config in mirrors section like this:
    
```
<mirror>   
   <id>internal-repo</id>   
   <mirrorOf>*</mirrorOf>   
   <url>http://repository:8081/nexus/content/groups/public/</url>   
</mirror>
```

#####3. Gradle

execute the following commands to install gradle:

```
shell> cd /opt
sehll> wget https://downloads.gradle.org/distributions/gradle-2.9-bin.zip
shell> unzip gradle-2.9-bin.zip
shell> echo "export GRADLE_HOME=/opt/gradle-2.9" >> /etc/profile.d/gradle.sh
shell> echo "export PATH=$PATH:$GRADLE_HOME/bin" >> /etc/profile.d/gradle.sh
shell> source /etc/profile
```
that's all for gradle setup.

#####4. Mysql

Now we are going to install Mysql, so please execute these commands :

```
shell> cd ~
shell> wget http://repo.mysql.com//mysql57-community-release-el6-7.noarch.rpm
shell> rpm -ivh mysql57-community-release-el6-7.noarch.rpm
shell> yum install postfix
shell> yum install mysql-community-server
shell> service mysqld start
```

Note! there will be a temporary password for root generated by mysql initialization process. you can find it in the mysql error log file(default location is /var/log/mysqld.log). the log entry that contains the temp password will look like this:

```
2015-11-26T06:31:55.896291Z 1 [Note] A temporary password is generated for root@localhost: lU?bdj=aA6h?
```
After retrieve the generated password, you may want to change it to whaterver you want by following this procedure:

```
shell> mysql -u root -p

mysql> ALTER USER 'root'@'localhost' IDENTIFIED BY 'MyNewPass';
```

Please note, your new password should contain Upper case letters , lower case letters, underscore and numbers.

#####5. Sonar

First, download Sonar's installation package and unzip it:

```
shell> cd /opt
shell> wget https://sonarsource.bintray.com/Distribution/sonarqube/sonarqube-5.2.zip
shell> unzip sonarqube-5.2.zip
```
The next step is to initialize Sonar's database:

```
shell> mysql -u root -p

mysql> CREATE USER 'sonar'@'localhost' IDENTIFIED BY 'Sonar_8364';
mysql> CREATE DATABASE sonardb;
mysql> GRANT ALL ON sonardb.* TO 'sonar'@'localhost';
mysql> quit;
```

adjust Sonar's configuration(${SONAR_HOME}/conf/sonar.properties) accordingly:

1. modify jdbc conf like this:

	```
	sonar.jdbc.username=sonar
	sonar.jdbc.password=Sonar_8364
	sonar.jdbc.url=jdbc:mysql://mysql_server_ip:3306/sonardb?useUnicode=true&characterEncoding=utf8&rewriteBatchedStatements=true&useConfigs=maxPerformance
```

2. adjust java opts:

	```
	sonar.web.javaOpts=-server -Xmx768m -Xms256m -XX:MaxPermSize=160m -XX:+HeapDumpOnOutOfMemoryError -Djava.net.preferIPv4Stack=true
	```

3. tweak web conf:

	```
	sonar.web.host=server_ip
	sonar.web.port=9000
	sonar.web.context=
	```

the sonar.properties shipped with sonar distribution is well documented, basiclly you can just uncomment certain lines(maybe a little twist according to your needs), and you will be set..

One last thing about Sonar's setup is to change the java executable used by Sonar: 

```
open ${SONAR_HOME}/conf/wrapper.conf and set wrapper.java.command to /opt/jdk1.7.0_79/bin/java
```

Final step, start Sonar: 
```
shell> ${SONAR_HOME}/bin/linux-x86-64/sonar.sh start
```

Note: when sonar start for the first time, it will execute a bunch of sqls to initialize its tables, so be patient if you cant visit http://server_ip:9000. you can issue 'tailf ${SONAR_HOME}/logs/sonar.log' to check the progress.

#####5. Jenkins

First install Jenkins by execute this following commands:

```
shell> cd /opt
shell> wget http://pkg.jenkins-ci.org/redhat/jenkins-1.638-1.1.noarch.rpm
shell> rpm -ivh jenkins-1.638-1.1.noarch.rpm
```

if jenkins doesnt start by root, please consider to adjust the access priviledge of maven's local repo, so that jenkins can download and read jars from there.

The next step is to config Jenkins. But this setup should be straight forward enough(thanks to Jenkins's self-explained labels), so I will just give some guide line:

1. adjust jenkins configuration file: /etc/sysconfig/jenkins according to your needs.
2. install plugins, like Email Extension Plugin, SonarQube Plugin, Gradle Plugin etc..
3. update plugins
4. add tools config in Jenkins' system configuration page. 
    - jdk
    - maven
    - smtp
    - subversion client version
    - SonarQube

####Optional Setup

#####1. ssh no password login

1. generate ssh keys: 
 
	```
	shell> ssh-keygen -t rsa
	shell> cat ~/.ssh/id_rsa.pub >> ~/.ssh/authorized_keys
	shell> chmod 600 ~/.ssh/authorized_keys
	```

2. copy public and private key to remote host. please note, the second command is optional. its purpose is to let the remote host can login current server without a password. if you dont want that, just skip it:
 
	```
	shell> ssh-copy-id host
	shell> scp ~/.ssh/id_rsa host:~/.ssh/
	```

#####2. Install Python2.7

The version of Python shipped with Centos 6.x is 2.6.x. So if you want to upgrade it, please consider the fowlloing upgrade instruction: 

```
shell> wget https://www.python.org/ftp/python/2.7.11/Python-2.7.11.tgz
shell> yum -y install zlib-devel bzip2-devel openssl-devel ncurses-devel sqlite-devel readline-devel tk-devel gdbm-devel db4-devel libpcap-devel xz-devel
shell> tar axf Python-2.7.11.tgz
shell> mv /usr/bin/python /usr/bin/python2.6 (optional, only if there is no /usr/bin/python2.6)
shell> vim /usr/bin/yum (change the first line of yum script from "#! /usr/bin/python" to "#! /usr/bin/python2.6")
shell> cd Python-2.7.11
shell> ./configure
shell> make
shell> make install
shell> wget https://bitbucket.org/pypa/setuptools/raw/bootstrap/ez_setup.py
shell> python2.7 ez_setup.py
shell> easy_install pip
```